#' Plot results
#'
#' Plots raw data and their summaries against regression
#' results, including verbal description of the results.
#'
#' @param data Tibble or data.frame. Raw data as generated
#'   by \code{import_data}.
#' @param stats Tibble or data.frame. Statistic comparisons
#'   as generated by \code{stat_test}.
#' @param specs Tibble or data.frame. Contains research
#'   questions operationalisation.
#' @param type Character.
#' @param save Logical. Save the plot into `figures` folder?
#'   Defaults to `TRUE` which also creates `figures/` if it
#'   does not exist yet.
#'
#' @returns A tibble with formatted marginal means and their
#'   comparisons.
#'
#' @export
plot_results <- function(
    data,
    stats,
    specs,
    type,
    save = TRUE) {
  # Keep only variables of interest:
  model_specs <- specs |>
    dplyr::filter(analysis == type) |>
    dplyr::filter(stringr::str_detect(estimate, "adjusted"))
  # Prepare text:
  text <- purrr::map_dfr(paste0(c("un",""), "adjusted"), function(i) {
    stats[[i]]$mPA |>
      dplyr::filter(Moderator == "") |>
      dplyr::filter(Analysis == type) |>
      dplyr::filter(Outcome %in% unique(model_specs$outcome)) |>
      dplyr::mutate(
        #est = i,
        comp = stringr::str_remove(Contrast, " .*"),
        ES = dplyr::if_else(
          df != Inf,
          glue::glue("d<sub>{sub('adjusted', 'adj.', i)}</sub> = {comp}"),
          glue::glue("OR<sub>{sub('adjusted', 'adj.', i)}</sub> = {comp}")
        ),
        stat = dplyr::if_else(
          df != Inf,
          true = glue::glue("t({df}) = {Statistic}"),
          false = glue::glue("z = {Statistic}")
        ),
        p = dplyr::if_else(
          `p value` != "< .001",
          true = glue::glue("p = {`p value`}"),
          false = glue::glue("p {`p value`}")
        ),
        label = paste(ES, p, sep = ", ")
      ) |>
      dplyr::select(Outcome, label)
  }) |>
    dplyr::mutate(
      x = "COSACTIW",
      y = unlist(dplyr::case_when(
        type == 1 ~ list(c(4.77, 1, -1.4, 13.33, 16.3, 1, 1, .24, 4.12, .86, -1.9, 11.5, 14.12, .86, .86, .1)),
        type == 2 ~ list(c(-1.99, -3.85, -3.53, -2.02, -2.4, -4.4, -4, -2.5))
      ))
    )
  # Prepare data:
  input <- data |>
    dplyr::mutate(dplyr::across(
      .cols = c("SA", "cPA", "Depr", "Anx"),
      .fns = \(x) dplyr::if_else(x == 1, 1, 0)
    )) |>
    tidyr::pivot_longer(
      cols = unique(model_specs$outcome),
      names_to = "Outcome",
      values_to = "Score"
    ) |>
    dplyr::mutate(
      type = unlist(sapply(seq_len(dplyr::n()), function(i) {
        with(model_specs, {
          ifelse(
            unique(likelihood[outcome == Outcome[i]]) == "gaussian",
            yes = "continuous",
            no = "binary"
          )
        })
      }), use.names = FALSE))
  # Extract variable names:
  vars <- lapply(rlang::set_names(unique(input$type)), function(i) {
    unlist(
      unique(input[input$type == i, "Outcome"]),
      use.names = FALSE
    )
  })
  # Labels for continuous plots:
  labs <- unlist(dplyr::if_else(
    type == 1,
    true = list(c(FAQ = "FAQ", GAI = "GAI", GDS15 = "GDS-15",Z_SA = "Cognition CS")),
    false = list(c(Delayed_recall_z = "Memory (delayed recall)", TMT_B_z = "TMT-B", BNT_30_z = "BNT-30", VF_Animals_z = "Verbal Fluency (animals)"))
  ))
  # Levels of factors for continuous plots:
  levs <- unlist(dplyr::if_else(
    type == 1,
    true = list(c("GAI", "GDS15", "FAQ", "Z_SA")),
    false = list(c("Delayed_recall_z", "TMT_B_z", "BNT_30_z", "VF_Animals_z"))
  ))
  cols <- type |>
    stringr::str_remove("0") |>
    as.numeric()
  # Continuous variables:
  conplot <- input |>
    dplyr::filter(type == "continuous") |>
    ggplot2::ggplot() +
    ggplot2::aes(x = mPA, y = Score) +
    ggplot2::geom_violin(width = 1) +
    ggplot2::geom_boxplot(width = 0.2, alpha = 0.8) +
    ggplot2::stat_summary(
      fun = mean,
      geom = "point",
      shape = 20,
      size = 5,
      colour = "red3",
      fill = "red3"
    ) +
    ggplot2::labs(
      y = dplyr::case_when(type == 1 ~ "Score", type == 2 ~ "Z-score"),
      x = NULL
    ) +
    ggplot2::facet_wrap(
      facets = ~ factor(Outcome, levels = levs), # factor to force order
      ncol = cols,
      scales = "free_y",
      labeller = ggplot2::as_labeller(labs)
    ) +
    ggplot2::theme_bw() +
    ggplot2::theme(panel.grid = ggplot2::element_blank()) +
    ggtext::geom_richtext(
      data = text |> dplyr::filter(Outcome %in% vars$continuous),
      mapping = ggplot2::aes(y = y, x = x, label = label),
      nudge_x = .5,
      label.size = .1,
      size = 3
    )
  # Binary variables:
  binplot <- input |>
    dplyr::filter(type == "binary") |>
    ggplot2::ggplot() +
    ggplot2::aes(x = mPA, y = Score, group = Outcome) +
    ggplot2::geom_point(
      position = ggplot2::position_jitter(width = .15, height = .033),
      alpha = .25,
      size = 3.3
    ) +
    ggplot2::geom_smooth(
      method = "glm",
      se = FALSE,
      method.args = list(family = "binomial"),
      colour = "red3",
      linewidth = 1.33
    ) +
    ggplot2::scale_x_discrete(expand = ggplot2::expansion(add = .25)) +
    ggplot2::scale_y_continuous(breaks = c(0, 1), labels = c(0, 1), name = NULL) +
    ggplot2::labs(x = NULL) +
    ggplot2::facet_wrap(
      facets = ~ factor( Outcome, levels = c("Anx", "Depr", "cPA", "SA") ),
      ncol = 1,
      scales = "free_y",
      labeller = ggplot2::as_labeller(
        c(Anx = "Anxiety risk", cPA = "cPA", Depr = "Depression risk", SA = "SA")
      )
    ) +
    ggplot2::theme_bw() +
    ggplot2::theme(panel.grid = ggplot2::element_blank()) +
    ggtext::geom_richtext(
      data = text |> dplyr::filter(Outcome %in% vars$binary),
      mapping = ggplot2::aes(y = y, x = x, label = label),
      nudge_x = .5,
      label.size = .1,
      size = 3
    )
  # Put plot togehter:
  if (type %in% c("1", "10")) {
    plt <- ggpubr::ggarrange(conplot, binplot, ncol = 2)
    fname <- "data-and-stats.jpg"
  } else {
    plt <- conplot
    fname <- "cognitive-tests.jpg"
  }
  # Save it:
  if (save) {
    if (!dir.exists("figures")) {
      dir.create("figures")
    }
    ggplot2::ggsave(
      plot = plt,
      filename = here::here("figures", fname),
      dpi = 300,
      height = dplyr::case_when(type == 1 ~ 9.9, type == 2 ~ 7.5),
      width = dplyr::case_when(type == 1 ~ 9.0, type == 2 ~ 7.5)
    )
  }
  plt
}
